<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tiny5&display=swap" rel="stylesheet">

<title>Chroma Circular Visualizer</title>
<style>
  body {
    margin: 0;
    /* Chroma Theme Background */
    background: radial-gradient(circle at center, #1a2e33 0%, #05080a 70%, #000000 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    flex-direction: column;
    color: white;
    overflow: hidden;
    font-family: "Tiny5", sans-serif;
  }

  /* OVERLAY */
  #overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 100;
    cursor: pointer;
  }
  
  #overlay h1 {
    font-size: 80px;
    margin: 0;
    color: #fff;
    text-shadow: 0 0 10px #3BC1A8;
    letter-spacing: 5px;
    animation: float 3s ease-in-out infinite;
  }
  
  #overlay p {
    color: #3BC1A8;
    margin-top: 10px;
    font-size: 20px;
    animation: blink 1s infinite;
  }

  /* CONTAINER */
  .visualizer-container {
    position: relative;
    width: 600px;
    height: 600px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    position: absolute;
    top: 0; left: 0;
    z-index: 2;
    pointer-events: none;
    image-rendering: pixelated; 
  }

  /* WEBCAM */
  #webcam {
    position: absolute;
    z-index: 1;
    /* Fixed Size: Radius 130 * 2 = 260px */
    width: 260px; 
    height: 260px;
    border-radius: 50%; 
    object-fit: cover;
    transform: scaleX(-1);
    background: #05080a;
    border: 4px solid #1a2e33;
    box-shadow: 0 0 20px rgba(59, 193, 168, 0.1);
  }

  /* HIDDEN AUDIO */
  audio { display: none; }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>
</head>
<body>

    <div id="overlay">
        <h1>CHROMA</h1>
        <p>[ CLICK TO START ]</p>
    </div>

    <div class="visualizer-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="visualizer" width="600" height="600"></canvas>
    </div>

    <audio id="audio" src="audio/edm.mp3" crossorigin="anonymous" loop></audio>

    <script>
    // --- SETTINGS ---
    const CONFIG = {
        radius: 130,     // Fixed Radius
        barLen: 70,      
        barCount: 80 
    };

    const THEME_COLOR = "#3BC1A8";

    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("webcam");
    const audio = document.getElementById("audio");
    const overlay = document.getElementById("overlay");

    let audioCtx, analyser, dataArray, source;
    let isRunning = false;

    overlay.addEventListener("click", async () => {
        overlay.style.display = "none";
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256; 
        
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        if (!source) {
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
        }
        
        await audioCtx.resume();
        audio.play().catch(e => console.log("Audio play failed:", e));
        startWebcam();
        
        if (!isRunning) {
            isRunning = true;
            draw();
        }
    });

    function startWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { video.srcObject = stream; })
                .catch(err => {
                    console.error("Camera Error:", err);
                    alert("Camera blocked. Please run on localhost.");
                });
        }
    }

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        
        const angleStep = (Math.PI * 2) / CONFIG.barCount;

        for (let i = 0; i < CONFIG.barCount; i++) {
            let norm = i / (CONFIG.barCount / 2);
            if (norm > 1) norm = 2 - norm;
            
            const dataIdx = Math.floor(norm * 60) + 4; 
            const val = dataArray[dataIdx] || 0;

            const normalizedVal = val / 255;
            const len = Math.pow(normalizedVal, 3) * CONFIG.barLen;

            const angle = (i * angleStep) - (Math.PI / 2);
            const nx = Math.cos(angle);
            const ny = Math.sin(angle);

            const x1 = cx + nx * (CONFIG.radius + 2);
            const y1 = cy + ny * (CONFIG.radius + 2);
            
            const x2 = cx + nx * (CONFIG.radius + 2 + len);
            const y2 = cy + ny * (CONFIG.radius + 2 + len);

            ctx.strokeStyle = THEME_COLOR;
            ctx.shadowBlur = normalizedVal * 15; 
            ctx.shadowColor = THEME_COLOR;
            ctx.lineWidth = 8; 
            ctx.lineCap = "butt"; 

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            
            ctx.shadowBlur = 0;
        }

        // Circular Bezel
        ctx.strokeStyle = "#1a2e33"; 
        ctx.lineWidth = 0;
        ctx.beginPath();
        ctx.arc(cx, cy, CONFIG.radius, 0, Math.PI * 2);
        ctx.closePath();
        ctx.stroke();
    }
    </script>
</body>
</html>